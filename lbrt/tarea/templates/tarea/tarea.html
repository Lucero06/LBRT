
{% extends 'base.html' %}



{% block body %}
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'tarea/style.css' %}">
<div id="programar">
<p>
    <h2 style="display:inline-block">
        Creación de ordenes 
        <span style="font-size:.56em">
            Tarea que crea orden y la mantiene arriba por un tiempo determinado.
        </span>
    </h2>
    
</p>
    
Configuración de orden:
<br><br>
<table>
    <tr>
        <td><label>*Pool:</label></td>
        <td>
            <select id="pools">
                {% comment %} <option value=""> Seleccione (nombre de pool - stratum host name - algoritmo) </option> {% endcomment %}
                {% for pool in pools %}
                <option value="{{pool.id}}///{{pool.algorithm}}///{{pool.stratumHostname}}">
                    {{ forloop.counter }}: {{pool.name}} - {{pool.stratumHostname}} - {{pool.algorithm}}
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            *
        </td>
    </tr>
    <tr>
        <td>*Amount</td>
        <td>
            <input type="number" step="any" name="amount" id="amount" value="0.001"> BTC
        </td>
        <td>
            *
        </td>
    </tr>
     <tr>
        <td><label>*Limit</label> </td>
        <td><input id="limit" type="number" step="any" name="limit" value="0.001"> THs</td>
        <td>
            *
        </td>
    </tr> 
    <tr>
        <td>Time </td>
        <td>
            <input type="number" name="time_up" value="3" id="time_up"> Min
        </td>
        <td>
            Tiempo UP (ON)
        </td>
    </tr>
</table>
<br>
<br>
</div>

Crear orden cada <b>n</b> tiempo:
Si<input type="radio" name="periodica" id="periodica_si" value="si" checked>
No<input type="radio" name="periodica" id="periodica_no" value="no">
<br><br>
<form action="#">

    Cada
    <input type="number" id="intervalo" name="intervalo" value="5">
    <select name="tipo_intervalo" id="tipo_intervalo">
        <option value="minuto">Minuto(s)</option>
        <option value="hora">Hora(s)</option>
        <option value="dia">Día(s)</option>    
    </select>
    Inicio:
    <input type="time" name="inicio" id="inicio" value="{{hora}}:{{minuto}}">
</form>
<br>
<center>
<button id="btnstart">Crear tarea</button>
</center>
<br>
<br><br>
Log:<br>
<span id="status"></span>

<div id="info_blocks">
    <textarea id="log-task" cols="150" rows="20" readonly></textarea>
    <br>
</div>

<!--{% for schedule in schedules %}
    {{schedule.every}}
    {{schedule.period}}
    {{schedule.last_run_at}}
{% endfor%}-->
<h4>Tareas actuales</h4>
<table>
    <tr>
        <th>Status</th>
        <th>Nombre</th>
        <th>Periodica </th>
        <th>Inicio</th>
        <th>Cada</th>
        <th>Intervalo</th>
        <th>Tarea</th>
        <th>Id</th>
        <th>Acciones</th>
    </tr>
{% for task in periodic_tasks %}
<tr>
    <td>{{task.enabled}}</td>
    <td>{{task.name}}</td>
    <td>
        {% if task.one_off == True %} No {% else %} Si {% endif %}
    </td>
    <td>{{task.last_run_at}}</td>
    <td>{{task.interval.every}}</td>
    <td>{{task.interval.period}}</td>
    <td>{{task.task}}</td>
    <td>{{task.id}}</td>
    <td><button disabled>Desactivar</button> <button onclick="del_task({{task.id}},'periodica_si')">Eliminar</button> <button disabled>Informacion</button></td>
</tr>
{% endfor%}
</table>


<h4>Resultado de Tareas</h4>
<table>
    <tr>
        <th>Nombre</th>
        <th>Tarea periodica</th>
        <th>Id</th>
        <th>Status</th>
        <th>Ejecución</th>
    </tr>
    {% for task in tasks_results %}
    <tr>
        
        <td>{{task.task_name}}</td>
        <td>{{task.periodic_task_name}}</td>
        <td>{{task.task_id}}</td>
        <td>{{task.status}}</td>
        <td>{{task.result}}</td>
        
    </tr>
    {% endfor%}
</table>


<div id="tarea_actual">



</div>

{% endblock %}

{% block scripts%}
<script>
    function scroll(){
        document.querySelector('#log-task').scrollTop = document.querySelector('#log-task').scrollHeight;
    }

    var wss_protocol = (window.location.protocol == 'https:') ? 'wss://': 'ws://';
    var tareaSocket = new WebSocket(
        wss_protocol + window.location.hostname + '{{wsport}}/ws/'
        );
    console.log(window.location.host );
    tareaSocket.onopen = function(e) {
        document.querySelector('#status').innerHTML = ('Conexión ws abierta\n')    
    }

    tareaSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        
        var message = data['message'];  

        document.querySelector('#log-task').innerHTML+='\n\n';

        if (message['log_time']){
            document.querySelector('#log-task').innerHTML+=message['log_time'];
            document.querySelector('#log-task').innerHTML+=':';
            document.querySelector('#log-task').innerHTML+='\n';
            for(const att in message){
                console.log(att);
                console.log(message[att]);
                if (att != 'log_time'){
                    document.querySelector('#log-task').innerHTML+=att;
                    document.querySelector('#log-task').innerHTML+=': ';
                    document.querySelector('#log-task').innerHTML+=JSON.stringify(message[att]);
                    document.querySelector('#log-task').innerHTML+=' ';
                }
                
            }
        }
        else{
            document.querySelector('#log-task').innerHTML+=JSON.stringify(message);   
        }        
        //document.querySelector('#log-task').innerHTML+=JSON.stringify(message);
        document.querySelector('#status').innerHTML=message['status'];
        document.querySelector('#status').className=message['status'];
        scroll();
        console.log(message)

    };

    tareaSocket.onclose = function(e) {
        document.querySelector('#status').value += ('Socket closed unexpectedly, please reload the page.\n')
    };

    document.querySelector('#btnstart').onclick = function(e) {
        
        console.log('boton enviar datos');
        
        //parametros orden
        limite=document.querySelector('#limit').value;
        time_up=document.querySelector('#time_up').value;
        pool=document.querySelector('#pools').value;
        amount=document.querySelector('#amount').value;
        //parametros tarea
        inicio=document.querySelector('#inicio').value;
        tipo_intervalo=document.querySelector('#tipo_intervalo').value;
        intervalo=document.querySelector('#intervalo').value;
        tipo='add_tarea';
        periodica='no';
        if(document.querySelector('#periodica_si').checked==true){
            periodica='si';
        }

        params={
                    'inicio':inicio,
                    'amount':amount,
                    'time_up':time_up,
                    'limite':limite,
                    'intervalo':intervalo,
                    'tipo_intervalo':tipo_intervalo,
                    'periodica':periodica,
                    'pool':pool
                }
        console.log(params);
        //enviar datos
        tareaSocket.send(JSON.stringify({
            'message': {
                'tipo':tipo,
                'params':params
            	
            }
        }));
        
    };

    function del_task(id,periodica_yn){
        tareaSocket.send(JSON.stringify({
            'message': {
                'tipo':'del_task',
                'params':{
                    'task_id':id,
                    'periodica':periodica_yn
                }
            }
        }));
    }


    function hora(){
        const d = new Date();
        let hour=d.getHours();
        let minutes = d.getMinutes();
        minutes=String(minutes).padStart(2,'0');
        hour=String(hour).padStart(2,'0');

        hora_manual=document.querySelector('#inicio').value.split(':');
        tiempo_manual="".concat(hora_manual[0],hora_manual[1]);

        tiempo_actual="".concat(hour,minutes);

        if (tiempo_manual<tiempo_actual){
            document.querySelector('#inicio').value=hour+':'+minutes;    
        }

        //console.log(tiempo_manual);
        //console.log(tiempo_actual);
        
    }

    window.setInterval(hora,1000);

</script>
{% endblock %}